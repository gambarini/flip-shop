# Flip-shop Improvement Tasks Checklist

Below is a prioritized, logically ordered checklist of actionable improvements spanning architecture, code quality, testing, documentation, and tooling. Each task starts with a placeholder to check off upon completion.

1. [x] Unify HTTP error handling by removing legacy helpers in internal/route/route.go and using utils.AppServer response helpers everywhere. Ensure consistent Content-Type on errors. (Architecture/API)
2. [x] Standardize response headers: set Content-Type: application/json on all responses including errors across handlers. (API Consistency)
3. [x] Add input validation for handler payloads (purchase/remove):
   - [x] Validate SKU is non-empty and known format. (Code-level)
   - [x] Validate qty > 0 for add and remove operations; return 422 with clear error. (Code-level)
   - [x] Use json.Decoder with DisallowUnknownFields to reject unexpected fields. (Code-level)
4. [x] Replace ioutil.ReadAll with json.NewDecoder for request bodies (Go 1.16+ compatible) to stream and catch malformed JSON early. (Code modernization)
5. [x] Normalize 404/422 mapping:
   - [x] purchase/remove: map ErrCartNotFound to 404, ErrItemNotFound and domain validation to 422. (API correctness)
   - [x] Use AppServer.ResponseErrorNotfound/ResponseErrorEntityUnproc consistently. (API correctness)
6. [x] Rename memdb constructor NewDMemoryKVDatabase to NewMemoryKVDatabase (keep deprecated alias for backward compatibility) and update call sites. (Naming/Clarity)
7. [x] Improve memdb transactional semantics:
   - [x] Implement copy-on-write snapshot per transaction to enable rollback on handler error. (Architecture)
   - [x] Document isolation (mutex-guarded serializable) and transactional rollback behavior in utils/memdb package comment. (Docs)
8. [x] Add unit tests for repositories using WithTx to validate read/store paths and error cases (ErrValueNotFound mapping to repo errors). (Testing)
9. [x] Add handler-level tests (httptest) for routes using utils.NewServer to register routes in-memory:
   - [x] POST /cart happy path. (Testing)
   - [x] PUT /cart/{id}/purchase happy path and 422 cases (invalid qty, unavailable item). (Testing)
   - [x] DELETE /cart/{id}/purchase happy path and 422/404 cases. (Testing)
   - [x] PUT /cart/{id}/status/submitted with promotions applied. (Testing)
10. [x] Strengthen promotion tests for edge cases and ordering/idempotency:
    - [x] Free item price-free promotion: verify discount accumulation for multiples. (Testing)
    - [x] Percentage discount rounding rules and precision. (Testing)
    - [x] Interactions when multiple promotions affect same SKU. (Testing)
11. [x] Make server port and initial inventory configurable via environment variables or a config struct; keep defaults to preserve current behavior. (Configuration)
12. [x] Add a /health (GET) endpoint returning 200 and basic info (uptime/version) to aid operations. (Operability)
13. [x] Introduce request-scoped logging with a request ID (X-Request-ID or generated UUID) in AppServer.requestInterceptor; include method, path, and duration. (Observability)
14. [x] Switch to structured logging (logfmt or JSON) behind a minimal interface to enable better parsing in production; default to standard log for simplicity. (Observability)
15. [x] Ensure handlers always write headers before body and avoid duplicate WriteHeader calls; add helper for JSON responses to reduce repetition. (API/Code hygiene)
16. [x] Add context timeouts to HTTP server and requests processing where applicable (e.g., read/write timeouts on http.Server). (Reliability)
17. [x] Add go vet and staticcheck/golangci-lint to CI; fix any reported issues. (Tooling/Quality)
18. [x] Add GitHub Actions CI workflow mirroring ./ci.sh (go test ./..., go build), including race detector and coverage upload artifact. (CI)
19. [x] Improve README: expand API docs with example requests/responses, list promotions with examples, and document error responses/codes. (Documentation)
20. [x] Provide an OpenAPI (Swagger) specification for the HTTP API (docs/openapi.yaml) and link from README. (Documentation)
21. [x] Add examples directory with curl scripts or a Postman/Insomnia collection to exercise endpoints locally. (DX)
22. [x] Ensure all public types/functions have GoDoc comments (utils, repos, routes, models), especially exported error values. (Documentation/Style)
23. [x] Review and harmonize naming across packages (e.g., CartStatusAvailable vs. "Submitted" constants, repo interfaces prefixes). (Consistency)
24. [x] Guard against integer overflow on totals/discounts and clarify money representation (int64 cents). Consider introducing a Money type alias or small struct. (Correctness)
25. [x] In submit handler, short-circuit on promotion Apply errors inside the loop; add tests showing that failing promotion does not partially apply. (Correctness)
26. [x] Add defensive checks when applying promotions: ensure cart state doesnâ€™t exceed reserved quantities; maintain invariants if promotions add items. (Correctness)
27. [x] Extract shared JSON marshalling/write logic into a small helper to centralize error handling and header setting. (Code reuse)
28. [x] Use early returns consistently and remove dead code paths (e.g., unreachable returns). (Code hygiene)
29. [x] Add module-wide context cancellation handling in AppServer.Start to stop background goroutines cleanly (if introduced later). (Reliability)
30. [x] Add coverage reporting target (makefile or script) and a coverage threshold gate in CI if practical. (Quality)
31. [x] Add benchmark tests for critical operations (reservation, purchase, submit) to track performance over time. (Performance)
32. [ ] Consider extracting domain-specific errors into dedicated packages or files for clearer mapping in HTTP layer. (Architecture)
33. [ ] Consider layering route registration to keep SetRoutes minimal: create a RouterRegistrar that encapsulates paths and handlers. (Architecture)
34. [ ] Add versioning to API routes (e.g., /v1) to ease future evolution; keep old routes for compatibility initially. (API Evolution)
35. [ ] Add a simple seed loader that reads initial inventory from JSON/CSV, gated via an env var; fallback to hardcoded defaults. (Operability)
36. [ ] Add mutex-protected read-only getters on cart for safe concurrent reads if cart were shared across goroutines; document threading assumptions. (Future-proofing)
37. [ ] Ensure promotions are pure functions where possible; separate state mutation and calculation to simplify reasoning/testing. (Design)
38. [x] Add error wrapping with %w for better diagnostics; standardize fmt.Errorf usage in handlers. (Diagnostics)
39. [x] Replace magic strings for store names with typed constants exposed from repository packages to avoid drift. (Maintainability)
40. [ ] Add a simple rate limiter/middleware option in AppServer for basic DoS protection (configurable, default off). (Resilience)
